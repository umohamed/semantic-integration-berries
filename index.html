<!DOCTYPE html>
<html>
    <head>
        <title> My Experiment </title>
        <script src="https://unpkg.com/jspsych@7.3.3"></script>
        <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.2"></script>
        <script src="jspsych/modified-image-plugin.js"> </script>
        <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
        <script src="sentences.js"> </script>
        <script src="berriespriming.js"> </script>
        <script src="association.js"> </script>

    </head>
    <body> </body>
    <script>
        const jsPsych = initJsPsych();
        //need to add instructions 
        var inital_instructions = {
            type: jsPsychInstructions, 
            pages: [
                'Welcome to our experiment. Thank you for taking the time.',
                'First will be the training block. Read each sentence at your own pace and press the space bar to continue. There will be attention checks in the sentence blocks. After one of the blocks, there will be an association trial where you will respond to the displayed word with the first word that comes to mind.',
                'Finally, you will complete the priming block.'
            ],
            show_clickable_nav: true 
        }

        var association_instructions = {
            type: jsPsychInstructions, 
            pages: [
                'Done with sentences. Association time.'
            ],
            show_clickable_nav: true 
        }
        var priming_instructions = {
            type: jsPsychInstructions, 
            pages: [
                'Priming task about to begin. Images will be displayed and you will respond using either the "A" or "L" key.'
            ],
            show_clickable_nav: true 
        }

        var slow_experiment_trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "<b> Too slow </b>! <br><br> Please try to respond faster.",
            choices: "NO_KEYS",
            trial_duration: 1000
        }

        var fixation= {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "+", 
            choices: "NO_KEYS",
            trial_duration: 500,
        }

        var sentence_number = 0;

        var sentence = {
         type: jsPsychHtmlKeyboardResponse,
         stimulus: jsPsych.timelineVariable('sentence'),
         choices: [" "],
         //kept for testing, will remove for final experiment
         trial_duration: 100,
         on_finish: function(data) {
            sentence_number = (sentence_number + 1) % 40;
            console.log("sentence_number=" + sentence_number);
         }
        } 

        var random_attention_trials = jsPsych.randomization.sampleWithoutReplacement([...Array(35).keys()].map(x => x + 5),3);

        console.log('random_attention_trials= ' + random_attention_trials);

        var attention = {
            type: jsPsychSurveyText,
            questions: [{prompt:"Type any ONE novel word from the previous sentence:"}]
        };

        var attention_conditional = {
            timeline: [attention], 
            conditional_function: function() {
                if(random_attention_trials.includes(sentence_number)) {return true;}
                else {return false;}
            }
        }
        var training_procedure = {
            timeline: [sentence, attention_conditional],
            timeline_variables: sentences, 
            randomize_order: true 
        };
        var association = {
            type: jsPsychSurveyText,
            preamble:  "Respond with the first word comes to mind",
            questions: [{prompt:jsPsych.timelineVariable("cue")}],
            trial_duration: 10
        };

        var association_procedure = {
            timeline: [association],
            timeline_variables: association_cues, 
            randomize_order: true, 
            repetitions: 3
        };
        var training_plus_association =  {
            timeline: [training_procedure, association_instructions, association_procedure],
        }

        var image = {
            type: jsPsychImageKeyboardResponse,
            stimulus: jsPsych.timelineVariable('image_path'),
            choices: "NO_KEYS",
            trial_duration: 500,
            stimulus_width: 500,
            maintain_aspect_ratio: true,
            prompt: "<span style = 'font-size:200%'><br><br></span"
        }

        var prime = {
            type: jsPsychImageKeyboardResponse,
            stimulus: jsPsych.timelineVariable('image_path'),
            trial_duration: 300,
            choices: "NO_KEYS",
            stimulus_width: 500,
            maintain_aspect_ratio: true,
            prompt: function() {
               return "<span style= 'font-size:200%'><br>" + String(jsPsych.timelineVariable('prime_word')) + "<br><span>";
            },
        }
        var target = {
            type:jsPsychImageKeyboardResponse,
           stimulus: jsPsych.timelineVariable('image_path'),
            choices: ["A", "L"],
            stimulus_width: 500,
            maintain_aspect_ratio:true,
            prompt: function() {
                return "<span style= 'font-size:200%'><br>" + String(jsPsych.timelineVariable('target_word')) + "<br><span>";
            },
        }

        var priming_feedback = {
            timeline: [slow_experiment_trial],
            conditional_function: function() {
            var rt = jsPsych.data.get().last(1).values()[0].rt;
                if (rt > 800) {
                    return true;
                } else {
                    return false; 
                }
                }
            }
        var priming_proc = {
            timeline: [fixation, image, prime, target,priming_feedback],
            timeline_variables: practice_stimuli,
            randomize_order: true
        }
        jsPsych.run([inital_instructions, training_plus_association,priming_instructions,priming_proc])
    
      
    </script>
</html>
